# Generated by Django 5.2.1 on 2025-08-22 16:36

from django.contrib.auth.hashers import make_password
from django.db import migrations
from django.utils import timezone


def seed_users_and_notices(apps, schema_editor):
    # models ê°€ì ¸ì˜¤ê¸°
    User = apps.get_model("auth", "User")
    UserProfile = apps.get_model("users", "UserProfile")
    UserNotificationSetting = apps.get_model("users", "UserNotificationSetting")
    Subscription = apps.get_model("users", "Subscription")
    PaymentMethod = apps.get_model("users", "PaymentMethod")
    BillingInvoice = apps.get_model("users", "BillingInvoice")
    Notice = apps.get_model("users", "Notice")

    # 1) ê´€ë¦¬ì(ìŠˆí¼ìœ ì €) & í…ŒìŠ¤íŠ¸ ì¼ë°˜ìœ ì € ì‹œë“œ (idempotent: ë°˜ë³µ ì‹¤í–‰ ì•ˆì „)
    admin, _ = User.objects.get_or_create(
        username="admin",
        defaults={
            "email": "admin@example.com",
            "password": make_password("testpassword123"),
            "is_staff": True,
            "is_superuser": True,
        },
    )

    demo, _ = User.objects.get_or_create(
        username="demo",
        defaults={
            "email": "demo@example.com",
            "password": make_password("testpassword123"),
            "is_staff": False,
            "is_superuser": False,
        },
    )

    # 2) í”„ë¡œí•„/ì•Œë¦¼ì„¤ì • ê¸°ë³¸ê°’
    for u, nick in [(admin, "ê´€ë¦¬ì"), (demo, "ë°ëª¨ìœ ì €")]:
        UserProfile.objects.get_or_create(
            user=u,
            defaults={"nickname": nick, "phone_number": "", "birthdate": None},
        )
        UserNotificationSetting.objects.get_or_create(user=u)

    # 3) ë°ëª¨ ìœ ì € ê³¼ê¸ˆ/ê²°ì œ ì˜ˆì‹œ (í”„ë¡ íŠ¸ì—ì„œ ëª©ë¡/íˆìŠ¤í† ë¦¬ ë³´ì—¬ì¤„ ë•Œ í•„ìš”í•˜ë©´)
    Subscription.objects.get_or_create(
        user=demo,
        defaults={
            "plan_name": "ë² ì´ì§ í”Œëœ",
            "monthly_price": 29900,
            "currency": "KRW",
            "next_payment_date": None,
        },
    )

    PaymentMethod.objects.get_or_create(
        user=demo,
        method_id="pm_demo_visa",
        defaults={"card_type": "VISA", "last4": "4242", "is_default": True},
    )

    BillingInvoice.objects.get_or_create(
        user=demo,
        invoice_id="inv_demo_001",
        defaults={
            "plan_name": "ë² ì´ì§ í”Œëœ",
            "amount": 29900,
            "currency": "KRW",
            "paid_at": timezone.now(),
        },
    )

    # 4) ê³µì§€ì‚¬í•­ ì‹œë“œ
    Notice.objects.get_or_create(
        public_id="ntc_welcome",
        defaults={
            "title": "í™˜ì˜í•©ë‹ˆë‹¤ ğŸ‘‹",
            "body": "MoPT ë°ëª¨ ê³„ì •ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.",
        },
    )
    Notice.objects.get_or_create(
        public_id="ntc_update_001",
        defaults={
            "title": "ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì•ˆë‚´",
            "body": "í™ˆ ëŒ€ì‹œë³´ë“œ ë°ì´í„°ê°€ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.",
        },
    )


def unseed(apps, schema_editor):
    User = apps.get_model("auth", "User")
    Notice = apps.get_model("users", "Notice")
    # ë˜ëŒë¦¬ê¸°(ì„ íƒ): ë°ëª¨ìš© ë°ì´í„°ë§Œ ì œê±°
    User.objects.filter(username__in=["admin", "demo"]).delete()
    Notice.objects.filter(public_id__in=["ntc_welcome", "ntc_update_001"]).delete()


class Migration(migrations.Migration):
    dependencies = [
        ("users", "0014_userprofile_profile_image_url"),
    ]

    operations = [
        migrations.RunPython(seed_users_and_notices, reverse_code=unseed),
    ]
